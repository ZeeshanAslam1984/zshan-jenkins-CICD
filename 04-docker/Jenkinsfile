pipeline {
    agent any

    environment {
        IMAGE_NAME = 'zeeshanaslam1984/zshan-jenkins-docker-flask-app'
        IMAGE_TAG  = "${IMAGE_NAME}:${env.GIT_COMMIT}"
        VENV_DIR   = "${WORKSPACE}/venv"
    }

    stages {
        stage('Sanity Check') {
            steps {
                sh 'echo ">>> Running Jenkinsfile from 04-docker <<<"'
            }
        }

        stage('Setup & Test') {
            steps {
                sh '''
                    echo "Creating virtual environment at $VENV_DIR..."
                    python3 -m venv $VENV_DIR

                    echo "Installing dependencies inside venv..."
                    $VENV_DIR/bin/pip install --upgrade pip setuptools wheel
                    $VENV_DIR/bin/pip install --break-system-packages -r 04-docker/requirements.txt

                    echo "Running tests (if any)..."
                    $VENV_DIR/bin/pytest || echo "No tests found, skipping."
                '''
            }
        }

        stage('Login to Docker Hub') {
            steps {
                sh '''
                    echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin
                '''
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                sh '''
                    echo "Building Docker image: ${IMAGE_TAG}"
                    docker build -t ${IMAGE_TAG} 04-docker
                    docker push ${IMAGE_TAG}
                '''
            }
        }
    }

    post {
        always {
            echo "Cleaning up virtual environment..."
            sh 'rm -rf $VENV_DIR'
        }
    }
}
